<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>도깨비 추격전 - 감성 업데이트</title>
    <style>
        :root { --main-bg: #1a1a1a; --overlay: rgba(0, 0, 0, 0.85); }
        body { margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background: var(--main-bg); color: white; font-family: 'Malgun Gothic', sans-serif; overflow: hidden; }
        
        /* 게임 캔버스 레이아웃 */
        #game-container { position: relative; width: 800px; height: 600px; }
        canvas { background: #2c3e50; border-radius: 8px; box-shadow: 0 0 30px rgba(0,0,0,0.7); cursor: none; }

        /* 상단 UI 정보 */
        #ui { position: absolute; top: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 30px; box-sizing: border-box; pointer-events: none; z-index: 10; }
        .status-box { background: rgba(0,0,0,0.5); padding: 8px 15px; border-radius: 20px; backdrop-filter: blur(5px); }

        /* 커스텀 게임 오버 창 */
        #game-over {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--overlay); display: none; flex-direction: column;
            justify-content: center; align-items: center; border-radius: 8px; z-index: 100;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #game-over h1 { font-size: 3rem; color: #e74c3c; margin-bottom: 10px; }
        #game-over p { font-size: 1.2rem; margin-bottom: 25px; color: #bdc3c7; }
        .stat-val { color: #f1c40f; font-weight: bold; font-size: 1.5rem; }

        /* 버튼 디자인 */
        #restart-btn {
            padding: 12px 35px; font-size: 1.1rem; background: #2ecc71; color: white;
            border: none; border-radius: 30px; cursor: pointer; transition: 0.3s;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
        }
        #restart-btn:hover { background: #27ae60; transform: scale(1.05); }
    </style>
</head>
<body>

<div id="game-container">
    <div id="ui">
        <div class="status-box" id="room-info">방 1 / 5</div>
        <div class="status-box" id="hide-status">숨기 가능 (SPACE)</div>
    </div>

    <div id="game-over">
        <h1>GAME OVER</h1>
        <p>도깨비에게 발각되었습니다!</p>
        <p>생존 시간: <span id="survival-time" class="stat-val">0</span>초</p>
        <button id="restart-btn" onclick="resetGame()">다시 도전하기</button>
    </div>

    <canvas id="gameCanvas"></canvas>
</div>

<script>
/** 1. 기초 환경 설정 **/
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const roomInfo = document.getElementById('room-info');
const hideStatus = document.getElementById('hide-status');
const gameOverScreen = document.getElementById('game-over');
const timeResult = document.getElementById('survival-time');

canvas.width = 800;
canvas.height = 600;

let gameActive = true;
let currentRoom = 0;
let startTime = Date.now(); // 게임 시작 시각 기록

/** 2. 캐릭터 및 시스템 데이터 **/
const player = {
    x: 100, y: 300, size: 30, color: '#3498db', speed: 5,
    shakeOffset: 0 // 숨었을 때 떨림 효과용
};

const hideConfig = {
    isHiding: false,
    canHide: true,
    duration: 3000,
    coolDown: 5000
};

const ghost = {
    x: 700, y: 300, size: 35, color: '#e74c3c', speed: 2.6,
    room: 2, wanderX: 700, wanderY: 300
};

const furniture = [
    [{x: 150, y: 100, w: 100, h: 100}, {x: 500, y: 350, w: 150, h: 80}],
    [{x: 300, y: 200, w: 200, h: 200}],
    [{x: 100, y: 100, w: 80, h: 150}, {x: 600, y: 400, w: 100, h: 100}],
    [{x: 200, y: 400, w: 400, h: 60}],
    [{x: 50, y: 50, w: 100, h: 100}, {x: 650, y: 450, w: 100, h: 100}]
];

/** 3. 입력 처리 **/
const keys = {};
window.addEventListener('keydown', e => {
    keys[e.code] = true;
    if(e.code === 'Space' && gameActive) tryHide();
});
window.addEventListener('keyup', e => keys[e.code] = false);

function tryHide() {
    if (hideConfig.canHide && !hideConfig.isHiding) {
        hideConfig.isHiding = true;
        hideConfig.canHide = false;
        setTimeout(() => {
            hideConfig.isHiding = false;
            setTimeout(() => { hideConfig.canHide = true; }, hideConfig.coolDown);
        }, hideConfig.duration);
    }
}

/** 4. 로직 업데이트 **/
function update() {
    if (!gameActive) return;

    // 플레이어 이동 및 떨림 효과
    if (!hideConfig.isHiding) {
        if (keys['ArrowUp'] && player.y > 0) player.y -= player.speed;
        if (keys['ArrowDown'] && player.y < canvas.height - player.size) player.y += player.speed;
        if (keys['ArrowLeft']) player.x -= player.speed;
        if (keys['ArrowRight']) player.x += player.speed;
        player.shakeOffset = 0;
    } else {
        // 숨었을 때 덜덜 떠는 연출 (랜덤 좌표 오프셋)
        player.shakeOffset = (Math.random() - 0.5) * 4;
    }

    // 방 이동
    if (player.x > canvas.width - 5 && currentRoom < 4) { currentRoom++; player.x = 20; }
    else if (player.x < 5 && currentRoom > 0) { currentRoom--; player.x = canvas.width - 40; }
    
    roomInfo.innerText = `현재 구역: ${currentRoom + 1} / 5`;
    updateUI();

    // 도깨비 AI
    handleGhostAI();
}

function handleGhostAI() {
    if (ghost.room !== currentRoom) {
        let targetX = (ghost.room < currentRoom) ? canvas.width + 50 : -50;
        ghost.x += (targetX > ghost.x ? 1 : -1) * ghost.speed;
        if (ghost.x > canvas.width + 40) { ghost.room++; ghost.x = -30; }
        else if (ghost.x < -40) { ghost.room--; ghost.x = canvas.width + 30; }
    } else {
        let targetX, targetY;
        if (!hideConfig.isHiding) {
            targetX = player.x; targetY = player.y;
        } else {
            if(Math.random() < 0.02) { 
                ghost.wanderX = ghost.x + (Math.random() - 0.5) * 300;
                ghost.wanderY = ghost.y + (Math.random() - 0.5) * 300;
            }
            targetX = ghost.wanderX; targetY = ghost.wanderY;
        }

        const dx = targetX - ghost.x, dy = targetY - ghost.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist > 5) {
            ghost.x += (dx / dist) * (hideConfig.isHiding ? 1.2 : ghost.speed);
            ghost.y += (dy / dist) * (hideConfig.isHiding ? 1.2 : ghost.speed);
        }

        const checkDist = Math.sqrt(Math.pow(player.x - ghost.x, 2) + Math.pow(player.y - ghost.y, 2));
        let nearFurniture = furniture[currentRoom].some(f => 
            player.x > f.x - 30 && player.x < f.x + f.w + 30 && player.y > f.y - 30 && player.y < f.y + f.h + 30
        );

        let limit = hideConfig.isHiding ? (nearFurniture ? 15 : 45) : 35;
        if (checkDist < limit) endGame();
    }
}

/** 5. 렌더링 (그리기) **/
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // 가구 및 문
    ctx.fillStyle = "#c0392b";
    if (currentRoom < 4) ctx.fillRect(canvas.width - 10, 200, 10, 200);
    if (currentRoom > 0) ctx.fillRect(0, 200, 10, 200);

    ctx.fillStyle = '#5d4037';
    furniture[currentRoom].forEach(f => {
        ctx.fillRect(f.x, f.y, f.w, f.h);
        ctx.strokeStyle = '#3e2723';
        ctx.strokeRect(f.x, f.y, f.w, f.h);
    });

    // 도깨비 그리기
    if (ghost.room === currentRoom) {
        ctx.beginPath();
        ctx.arc(ghost.x + 15, ghost.y + 15, 45, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(231, 76, 60, 0.1)";
        ctx.fill();
        ctx.fillStyle = ghost.color;
        ctx.fillRect(ghost.x, ghost.y, ghost.size, ghost.size);
        // 무서운 눈
        ctx.fillStyle = "white";
        ctx.fillRect(ghost.x + 6, ghost.y + 8, 6, 6);
        ctx.fillRect(ghost.x + 22, ghost.y + 8, 6, 6);
        ctx.fillStyle = "red";
        ctx.fillRect(ghost.x + 8, ghost.y + 10, 2, 2);
        ctx.fillRect(ghost.x + 24, ghost.y + 10, 2, 2);
    }

    // 플레이어 그리기 (눈동자 및 떨림 효과 추가)
    ctx.save();
    ctx.translate(player.shakeOffset, player.shakeOffset); // 떨림 적용
    
    if (hideConfig.isHiding) ctx.globalAlpha = 0.4;
    ctx.fillStyle = player.color;
    ctx.fillRect(player.x, player.y, player.size, player.size);
    
    // 귀여운 눈동자
    ctx.fillStyle = "white";
    ctx.fillRect(player.x + 5, player.y + 8, 8, 8);
    ctx.fillRect(player.x + 17, player.y + 8, 8, 8);
    ctx.fillStyle = "black";
    // 숨었을 때는 눈동자가 작아지며 위아래로 떨림
    let eyeSize = hideConfig.isHiding ? 2 : 4;
    ctx.fillRect(player.x + 8, player.y + 11, eyeSize, eyeSize);
    ctx.fillRect(player.x + 20, player.y + 11, eyeSize, eyeSize);
    
    ctx.restore();

    requestAnimationFrame(() => { update(); draw(); });
}

function updateUI() {
    if (hideConfig.isHiding) {
        hideStatus.innerText = "숨어있음! (들키지 않게 조심하세요)";
        hideStatus.style.color = "#f1c40f";
    } else if (!hideConfig.canHide) {
        hideStatus.innerText = "숨기 준비 중...";
        hideStatus.style.color = "#e74c3c";
    } else {
        hideStatus.innerText = "숨기 가능 (SPACE)";
        hideStatus.style.color = "#2ecc71";
    }
}

function endGame() {
    gameActive = false;
    const survivedTime = ((Date.now() - startTime) / 1000).toFixed(1);
    timeResult.innerText = survivedTime;
    gameOverScreen.style.display = 'flex';
}

function resetGame() {
    location.reload();
}

draw();
</script>
</body>
</html>